---
title: "Main script"
output:
  html_document: default
  pdf_document: default
---


Packages needed for analysis
```{r warning=FALSE, message=FALSE}
## install.packages("qualtRics")
library(qualtRics)
## install.packages("tidyverse")
library(tidyverse)
## install.packages("janitor")
library(janitor)
## install.packages("psych")
library(psych)
## install.packages("dataMaid")
library(dataMaid)
## install.packages("skimr")
library(skimr)
## install.packages("dplyr")
library(dplyr)
## install.packages("reshape2")
library(reshape2)
## install.packages("DT")
library(DT)  
## install.packages("tinytex")
library(tinytex)
```

Random Seed
```{r warning=FALSE, message=FALSE}
set.seed(10)
```


Creating different datasets from the csv file: ipip, stai,sam_arousal,sam_control,sam_emotional,age, gender. For each scales we computed the sum, the means, the median and SDs.
```{r warning=FALSE, message=FALSE}
Df <- read_survey("A large, multi-site test of SAM.csv") %>%
  clean_names()

names(Df) <- tolower(names(Df))
Df <- Df %>% rename(responseid = response_id) %>% 
  rename(group = fl_13_do) 

ipip <- Df %>% 
  select(responseid, group, starts_with("ipip")) 

ipip <- ipip %>% 
  transmute(responseid = responseid,
            group = group,
            ipip1 = ipip1,
            ipip2 = ipip2,
            ipip3 = ipip3,
            ipip4 = ipip4,
            ipip5 = ipip5,
            ipip6 = ipip6,
            ipip7 = ipip7,
            ipip8 = ipip8,
            ipip9 = ipip9,
            ipip10 = ipip10,
            ipip11_r = 6 - ipip11,
            ipip12_r = 6 - ipip12,
            ipip13_r = 6 - ipip13,
            ipip14_r = 6 - ipip14,
            ipip15_r = 6 - ipip15,
            ipip16_r = 6 - ipip16,
            ipip17_r = 6 - ipip17,
            ipip18_r = 6 - ipip18,
            ipip19_r = 6 - ipip19,
            ipip20_r = 6 - ipip20,)  %>%
mutate(ipip_tot = rowSums(select(., c(3:22))))

ipip$ipip_average <- rowMeans(cbind(ipip$ipip1,
                                    ipip$ipip2,
                                    ipip$ipip3,
                                    ipip$ipip4,
                                    ipip$ipip5,
                                    ipip$ipip6,
                                    ipip$ipip7,
                                    ipip$ipip8,
                                    ipip$ipip9,
                                    ipip$ipip10,
                                    ipip$ipip11_r,
                                    ipip$ipip12_r,
                                    ipip$ipip13_r,
                                    ipip$ipip14_r,
                                    ipip$ipip15_r,
                                    ipip$ipip16_r,
                                    ipip$ipip17_r,
                                    ipip$ipip18_r,
                                    ipip$ipip19_r,
                                    ipip$ipip20_r), na.rm = TRUE)

ipip$ipip_median <- median(cbind(ipip$ipip1,
                                 ipip$ipip2,
                                 ipip$ipip3,
                                 ipip$ipip4,
                                 ipip$ipip5,
                                 ipip$ipip6,
                                 ipip$ipip7,
                                 ipip$ipip8,
                                 ipip$ipip9,
                                 ipip$ipip10,
                                 ipip$ipip11_r,
                                 ipip$ipip12_r,  
                                 ipip$ipip13_r,
                                 ipip$ipip14_r,
                                 ipip$ipip15_r,
                                 ipip$ipip16_r,
                                 ipip$ipip17_r,
                                 ipip$ipip18_r,
                                 ipip$ipip19_r,
                                 ipip$ipip20_r), na.rm = TRUE)

ipip$ipip_sd <- sd(cbind(ipip$ipip1,
                         ipip$ipip2,
                         ipip$ipip3,
                         ipip$ipip4,
                         ipip$ipip5,
                         ipip$ipip6,
                         ipip$ipip7,
                         ipip$ipip8,
                         ipip$ipip9,
                         ipip$ipip10,
                         ipip$ipip11_r,
                         ipip$ipip12_r,
                         ipip$ipip13_r,
                         ipip$ipip14_r,
                         ipip$ipip15_r,
                         ipip$ipip16_r,
                         ipip$ipip17_r,
                         ipip$ipip18_r,
                         ipip$ipip19_r,
                         ipip$ipip20_r), na.rm = TRUE)

Stai <- Df %>% 
  select(responseid, group, starts_with("Stai")) 

Stai <- Stai %>% 
  transmute(responseid = responseid,
            group = group,
            Stai1_r = 5 - stai1,
            Stai2_r = 5 - stai2,
            Stai3 = stai3,
            Stai4 =  stai4,
            Stai5_r = 5 - stai5,
            Stai6 = stai6,
            Stai7 = stai7,
            Stai8_r = 5 - stai8,
            Stai9 = stai9,
            Stai10_r = 5 - stai10,
            Stai11_r = 5  - stai11,
            Stai12 = stai12,
            Stai13 = stai13,
            Stai14 = stai14,
            Stai15_r = 5 - stai15,
            Stai16_r = 5 - stai16,
            Stai17 = stai17,
            Stai18 = stai18,
            Stai19_r = 5 - stai19,
            Stai20_r = 5 - stai20,) %>%
  mutate(Stai_tot = rowSums(select(., c(3:22))))

Stai$Stai_average <- rowMeans(cbind(Stai$Stai1_r,
                                    Stai$Stai2_r,
                                    Stai$Stai3,
                                    Stai$Stai4,
                                    Stai$Stai5_r,        
                                    Stai$Stai6,
                                    Stai$Stai7,
                                    Stai$Stai8_r,
                                    Stai$Stai9,
                                    Stai$Stai10_r,
                                    Stai$Stai11_r,
                                    Stai$Stai12,
                                    Stai$Stai13,
                                    Stai$Stai14,
                                    Stai$Stai15_r,
                                    Stai$Stai16_r,
                                    Stai$Stai17,
                                    Stai$Stai18,
                                    Stai$Stai19_r,
                                    Stai$Stai20_r), na.rm = TRUE)

Stai$Stai_median <- median(cbind(Stai$Stai1_r,
                                 Stai$Stai2_r,
                                 Stai$Stai3,
                                 Stai$Stai4,
                                 Stai$Stai5_r,                                    
                                 Stai$Stai6,
                                 Stai$Stai7,
                                 Stai$Stai8_r,
                                 Stai$Stai9,
                                 Stai$Stai10_r,
                                 Stai$Stai11_r,
                                 Stai$Stai12,
                                 Stai$Stai13,
                                 Stai$Stai14,
                                 Stai$Stai15_r,
                                 Stai$Stai16_r,
                                 Stai$Stai17,
                                 Stai$Stai18,
                                 Stai$Stai19_r,
                                 Stai$Stai20_r), na.rm = TRUE)

Stai$Stai_sd <- sd(cbind(Stai$Stai1_r,
                         Stai$Stai2_r,
                         Stai$Stai3,
                         Stai$Stai4,
                         Stai$Stai5_r,
                         Stai$Stai6,
                         Stai$Stai7,
                         Stai$Stai8_r,
                         Stai$Stai9,
                         Stai$Stai10_r,
                         Stai$Stai11_r,
                         Stai$Stai12,
                         Stai$Stai13,
                         Stai$Stai14,
                         Stai$Stai15_r,
                         Stai$Stai16_r,
                         Stai$Stai17,
                         Stai$Stai18,
                         Stai$Stai19_r,
                         Stai$Stai20_r), na.rm = TRUE)

sam_emotional <- Df %>% 
  select(responseid, group, starts_with("Sam1")) 

sam_arousal <- Df %>% 
  select(responseid, group, starts_with("Sam2")) 

sam_control <- Df %>% 
  select(responseid, group, starts_with("Sam3")) 

gender <- Df %>%
  select(responseid, gender)

age <- Df %>%
  select(responseid, age) %>%
  mutate(mean = mean(age),
        median = median(age),
        sd = sd(age))
```
We have to check that on a descriptive level the level of stress in the control group is higher than in the other experimental groups.
```{r warning=FALSE, message=FALSE}
Stai %>%
  group_by(group) %>%
  summarise_at(vars(Stai_average), list(mean = mean))
```
We fixed the minimum sample size per group n=50 and the maximum N=500
```{r warning=FALSE, message=FALSE}
n=50
N=500
```
If the observations in the group are less than 50 the stress vector is not generated, if they are between 50 and 500 then the available observations are taken, if they are more than 500 then 500 observations are random sampled. This is done for each group.
```{r warning=FALSE, message=FALSE}
c1=filter(Stai, group == "Condition5:Bookchapter" ) 
if(nrow(c1) > n & nrow(c1)<N){
      control_s=c1$Stai_average
}  else if (nrow(c1) > N) {
  control_s=sample(c1$Stai_average,N)
} else
  control_s=NA

c2=filter(Stai, group == "Condition4:BodyScan" )
if(nrow(c2) > n & nrow(c2)<N){
      bs=c2$Stai_average
}  else if (nrow(c2) > N) {
  bs=sample(c2$Stai_average,N)
} else
  bs=NA

c3=filter(Stai, group == "Condition3:Loving-kindness " )
if(nrow(c3) > n & nrow(c3)<N){
      lk=c3$Stai_average
}  else if (nrow(c3) > N) {
  lk=sample(c3$Stai_average,N)
} else
  lk=NA

c4=filter(Stai, group == "Condition2:Mindful-Movements " ) 
if(nrow(c4) > n & nrow(c4)<N){
      mm=c4$Stai_average
}  else if (nrow(c4) > N) {
  mm=sample(c4$Stai_average,N)
} else
  mm=NA

c5=filter(Stai, group == "Condition1:Mindful-Breathing " )
if(nrow(c5) > n & nrow(c5)<N){
      mb=c5$Stai_average
}  else if (nrow(c5) > N) {
  mb=sample(c5$Stai_average,N)
} else
  mb=NA
```
Where sample size is sufficiently big we carry out the 4 BF test. If a group has not exceeded size 50 we get an error message. The alternative hypothesis is that the mean of the control in terms of stress is higher than that of the experimental group (one-side test).
```{r warning=F, message=F}
s1=ttestBF(x = control_s, y=mb,paired=F,nullInterval = c(0, Inf))

s2=ttestBF(x = control_s, y=lk,paired=F,nullInterval = c(0, Inf))

s3=ttestBF(x = control_s, y=mm,paired=F,nullInterval = c(0, Inf))

s4=ttestBF(x = control_s, y=bs,paired=F,nullInterval = c(0, Inf))
```

We identify the experimental groups that exceeded the threshold of BF=10 
```{r warning=FALSE, message=FALSE}
groups=c("Condition1:Mindful-Breathing ",
         "Condition3:Loving-kindness ",
         "Condition2:Mindful-Movements ",
         "Condition4:BodyScan",
         "Condition5:Bookchapter")
value=c(extractBF(s1)$bf[1],extractBF(s2)$bf[1],extractBF(s3)$bf[1],extractBF(s4)$bf[1],11)
data=data.frame(groups,value)
name=data[data$value>10,"groups"]
```

If a group exceeds BF=10 in stress, we compute the BF test also for sam_arousal, sam_control, sam_emotional as well, otherwise we obtain NA. Being this an exploratory analysis we do not commit the data collection to the threshold of 10 for the self-assessment manikin scale
```{r warning=FALSE, message=FALSE}
if(("Condition1:Mindful-Breathing " %in% name)==T){
  t1=ttestBF(x = filter(sam_arousal, group == "Condition5:Bookchapter" )$sam2_1,
             y=filter(sam_arousal, group == "Condition1:Mindful-Breathing " )$sam2_1,
             paired=F,
             nullInterval = c(0, Inf))
  t1b=ttestBF(x = filter(sam_control, group == "Condition5:Bookchapter" )$sam3_1,
             y=filter(sam_control, group == "Condition1:Mindful-Breathing " )$sam3_1,
             paired=F,
             nullInterval = c(0, Inf))
  t1c=ttestBF(x = filter(sam_emotional, group == "Condition5:Bookchapter" )$sam2_1,
             y=filter(sam_emotional, group == "Condition1:Mindful-Breathing " )$sam1_1,
             paired=F,
             nullInterval = c(0, Inf))
}  else
  t1=t1b=t1c=NA

if(("Condition3:Loving-kindness " %in% name)==T){
  t2=ttestBF(x = filter(sam_arousal, group == "Condition5:Bookchapter" )$sam2_1,
             y=filter(sam_arousal, group == "Condition3:Loving-kindness " )$sam2_1,
             paired=F,
             nullInterval = c(0, Inf))
  t2b=ttestBF(x = filter(sam_control, group == "Condition5:Bookchapter" )$sam3_1,
             y=filter(sam_control, group == "Condition3:Loving-kindness " )$sam3_1,
             paired=F,
             nullInterval = c(0, Inf))
  t2c=ttestBF(x = filter(sam_emotional, group == "Condition5:Bookchapter" )$sam2_1,
             y=filter(sam_emotional, group == "Condition3:Loving-kindness " )$sam1_1,
             paired=F,
             nullInterval = c(0, Inf))
}  else
  t2=t2b=t2c=NA

if(("Condition2:Mindful-Movements " %in% name)==T){
  t3=ttestBF(x = filter(sam_arousal, group == "Condition5:Bookchapter" )$sam2_1,
             y=filter(sam_arousal, group == "Condition2:Mindful-Movements " )$sam2_1,
             paired=F,
             nullInterval = c(0, Inf))
  t3b=ttestBF(x = filter(sam_control, group == "Condition5:Bookchapter" )$sam3_1,
             y=filter(sam_control, group == "Condition2:Mindful-Movements " )$sam3_1,
             paired=F,
             nullInterval = c(0, Inf))
  t3c=ttestBF(x = filter(sam_emotional, group == "Condition5:Bookchapter" )$sam2_1,
             y=filter(sam_emotional, group == "Condition2:Mindful-Movements " )$sam1_1,
             paired=F,
             nullInterval = c(0, Inf))
}  else
  t3=t3b=t3c=NA

if(("Condition4:BodyScan" %in% name)==T){
  t4=ttestBF(x = filter(sam_arousal, group == "Condition5:Bookchapter" )$sam2_1,
             y=filter(sam_arousal, group == "Condition4:BodyScan" )$sam2_1,
             paired=F,
             nullInterval = c(0, Inf))
  t4b=ttestBF(x = filter(sam_control, group == "Condition5:Bookchapter" )$sam3_1,
             y=filter(sam_control, group == "Condition4:BodyScan" )$sam3_1,
             paired=F,
             nullInterval = c(0, Inf))
  t4c=ttestBF(x = filter(sam_emotional, group == "Condition5:Bookchapter" )$sam2_1,
             y=filter(sam_emotional, group == "Condition4:BodyScan" )$sam1_1,
             paired=F,
             nullInterval = c(0, Inf))
}  else
  t4=t4b=t4c=NA
```


I select in the source datasets only those experimental groups that have passed BF=10
```{r warning=FALSE, message=FALSE}
Stai2=Stai %>%
  filter(group %in% name)

ipip2=ipip %>%
  filter(group %in% name)

```

We form through a left join a dataset containing the information of stress and neuroticism
```{r warning=FALSE, message=FALSE}
results<-merge(x=Stai2,y=ipip2,by="responseid",all.x=TRUE)
```


The first question we can ask ourselves is: is the interaction between neuroticism and the experimental group reasonable?
```{r warning=FALSE, message=FALSE}
model=lm(Stai_average ~ group.x + ipip_average + group.x:ipip_average, data=results)
summary(model)
```

At this point I build a Bayesian model with and without interaction and check whether the one with the interaction is preferable and observe the parameter estimates. I continue the data collection untill a BF of 10 is reached for the model with the interaction or until the total
maximum sample size is reach. the total maximum sample size is 120 (maximun n requested to each site) * n (number of sites that participate in the study). If the threshold of 10 (for 
the model with the interaction) is not reached or if the total maximum sample size is not reached data collection will be stopped 3 months after the beginning of the data collection. 
```{r warning=FALSE, message=FALSE}
full <- lmBF(Stai_average ~ group.x + ipip_average + group.x:ipip_average, data=results)
full
noInteraction <- lmBF(Stai_average ~ group.x + ipip_average, data=results)
allBFs <- c(full, noInteraction)
allBFs
full/noInteraction
chainsFull <- posterior(full, iterations = 10000)
summary(chainsFull[,1:7])
```





